CC = gcc
SRC = src/
NCORES = 40
CFLAGS = -Werror -Ofast -fno-omit-frame-pointer -ftree-vectorize -mavx -g -fopt-info-vec-all

.DEFAULT_GOAL = all

all: MDseq.exe MDpar.exe

MDseq.exe: $(SRC)MDseq.cpp
    module load gcc/11.2.0;\
    $(CC) $(CFLAGS) $(SRC)MDseq.cpp -lm -o MDseq.exe 2> vectorize_seq.txt

MDpar.exe: $(SRC)MDpar.cpp
    module load gcc/11.2.0;\
    $(CC) $(CFLAGS) $(SRC)MDpar.cpp -lm -fopenmp -o MDpar.exe 2> vectorize_par.txt

runseq: MDseq.exe
    sbatch --partition=cpar $(SRC)seq.sh

runpar: MDpar.exe
    sbatch --partition=cpar --cpus-per-task=$(NCORES) $(SRC)par.sh ${NCORES}

clean:
    rm ./MD*.exe
    $(MAKE) rm

rm:
    rm slurm*

recseq: MDseq.exe
    sbatch --partition=cpar $(SRC)perfseq.sh

recpar: MDpar.exe
    sbatch --partition=cpar --cpus-per-task=$(NCORES) $(SRC)perfpar.sh ${NCORES}

statseq: MDseq.exe
    sbatch --partition=cpar $(SRC)statseq.sh

statpar: MDpar.exe
    sbatch --partition=cpar --cpus-per-task=$(NCORES) $(SRC)statpar.sh ${NCORES}

profile: MD.exe
    gprof ./MD.exe gmon.out > analysis.txt

precision:
    python precision_test.py

teacher: MDpar.exe
    sh ${SRC}teacher.sh

test:
    $(MAKE) clean
    $(MAKE) MD.exe 
    $(MAKE) perf3
    $(MAKE) profile
    $(MAKE) precision